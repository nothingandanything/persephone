<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
<script>
	function deleteCart (DrinkID) {
		$.ajax({
			type: 'POST',
			url: '${pageContext.request.contextPath}/deleteCart',
			data: {"DrinkID": DrinkID},
			statusCode: {
				404: function() {  
					alert('提交地址url未发现'); 
				}  
			}
		});
	}
	
	function changeCart (DrinkID, Number, flag) {
		$.ajax({
			type: 'POST',
			url: '${pageContext.request.contextPath}/changeCart',
			data: {"DrinkID": DrinkID, "Number": Number, "flag": flag},
			dataType: "json",
			statusCode: {
				404: function() {  
					alert('提交地址url未发现'); 
				}  
			},
			success: function (data) {
				$('#CartItemList').empty();
				var priceTotal = 0;
				for (var i = 0; i < data.length; i++) {
					console.log(i);
					var a = '<div class="cart-single-item">\n' +
							'	<button type="button" class="close" id="' + data[i].DrinkID + '" onclick="deleteCart(this.id)"><i class="flaticon-cross"></i></button>\n' +
							'	<div class="product-img">' +
							'		<img src="${pageContext.request.contextPath}/client/img/' + data[i].drink.PicAddres + '" alt="Product Image">\n' +
							'	</div>\n' +
							'	<h6 class="product-name">' + data[i].drink.DrinkName + ' (' + data[i].DrinkSweet + '·' + data[i].DrinkTemp + '·' + data[i].DrinkSpec + ')</h6>\n' +
							'	<div class="number-input">\n' +
							'		<button class="minus" onclick="changeCart(\'' + data[i].drinkID + '\', \'' + data[i].Number + '\', \'minus\')"></button>\n' +
							'		<input class="quantity" min="1" max="99" name="quantity" value="' + data[i].Number + '" type="number">\n' +
							'		<button class="plus" onclick="changeCart(\'' + data[i].DrinkID + '\', \'' + data[i].Number + '\', \'plus\')"></button>\n' +
							'	</div>\n';
					if(data[i].DrinkSpec == '超级杯'){
						var price = data[i].Number * data[i].drink.DrinkPrice_Super;
						a = a + '	<h6 class="product-price">￥' + parseFloat(data[i].drink.DrinkPrice_Super).toFixed(1) + '</h6>\n' +
								'	<h6 class="product-total-price">￥' + parseFloat(price).toFixed(1) + '</h6>\n';
						priceTotal = priceTotal + parseFloat(price);
					}
					else if(data[i].DrinkSpec == '大杯'){
						var price = data[i].Number * data[i].drink.DrinkPrice_Big;
						a = a + '	<h6 class="product-price">￥' + parseFloat(data[i].drink.DrinkPrice_Big).toFixed(1) + '</h6>\n' +
								'	<h6 class="product-total-price">￥' + parseFloat(price).toFixed(1) + '</h6>\n';
						priceTotal = priceTotal + parseFloat(price);
					}
					else if(data[i].DrinkSpec == '中杯'){
						var price = data[i].Number * data[i].drink.DrinkPrice_Medium;
						a = a +'	<h6 class="product-price">￥' + parseFloat(data[i].drink.DrinkPrice_Medium).toFixed(1) + '</h6>\n' +
								'	<h6 class="product-total-price">￥' + parseFloat(price).toFixed(1) + '</h6>\n';
						priceTotal = priceTotal + parseFloat(price);
					}
					a = a +'</div>\n';
					$('#CartItemList').append(a);
				}
				$('#totalPrice').html(parseFloat(priceTotal).toFixed(1));
			}
		});
	}
</script>

<title>Cart</title>
</head>
<body>
<div class="page-wrapper">
<!-- Preloader -->
<div class="preloader"></div>
<jsp:include page="head.jsp"></jsp:include>

       <!--==================================================================== 
            Start Banner Section
        =====================================================================-->
        <section class="banner-section" style="background-image:url(${pageContext.request.contextPath}/client/img/banner.png);">
            <div class="container">
                <div class="banner-inner text-center">
                    <h2 class="page-title">Your Cart</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="${pageContext.request.contextPath}/client/index.jsp">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Cart</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </section>
        <!--==================================================================== 
            End Banner Section
        =====================================================================-->
        
        <!--==================================================================== 
           Start Cart Page
       =====================================================================-->
        <section class="cart-page mt-120 rmt-80 mb-120 rmb-80">
            <div class="container">
                <div class="row col-gap-60">

                    <div class="col-xl-8">
                        <div class="cart-total-product rmb-80 b1 br-5 p-50">
                            <h4 class="cart-heading">购物车</h4>
                            <div class="cart-title d-none d-md-flex">
                                <h5 class="product-title">商品</h5>
                                <h5 class="quantity-title">数量</h5>
                                <h5 class="price-title">单价</h5>
                                <h5 class="total-title">总价</h5>
                            </div>
                            <div class="cart-items pb-15" id="CartItemList">
                            	
                            	<c:set var="totalPrice" value="${0}"/>
                            	<c:forEach items="${CartItem}" var="item" varStatus="vs">
                            		
                            		<!-- 计算所有商品总价 -->
                            		<c:if test="${item.drinkSpec eq '超级杯'}">
                            			<c:set var="totalPrice" value="${totalPrice+item.number*item.drink.drinkPrice_Super}"/>
                                    </c:if>
                                    <c:if test="${item.drinkSpec eq '大杯'}">
                            			<c:set var="totalPrice" value="${totalPrice+item.number*item.drink.drinkPrice_Big}"/>
                                    </c:if>
                                    <c:if test="${item.drinkSpec eq '中杯'}">
                            			<c:set var="totalPrice" value="${totalPrice+item.number*item.drink.drinkPrice_Medium}"/>
                                    </c:if>
                            		
                                	<div class="cart-single-item">
                                    	<button type="button" class="close" id="${item.drinkID}" onclick="deleteCart(this.id)"><i class="flaticon-cross"></i></button>
                                    	<div class="product-img">
                                        	<img src="${pageContext.request.contextPath}/client/img/${item.drink.picAddres}" alt="Product Image">
                                    	</div>
                                    	<h6 class="product-name">${item.drink.drinkName} (${item.drinkSweet}·${item.drinkTemp}·${item.drinkSpec})</h6>
                                    	<div class="number-input">
                                      		<button class="minus" onclick="changeCart('${item.drinkID}', '${item.number}', 'minus')"></button>
                                      		<input class="quantity" min="1" max="99" name="quantity" value="${item.number}" type="number">
                                      		<button class="plus" onclick="changeCart('${item.drinkID}', '${item.number}', 'plus')"></button>
                                    	</div>
                                    	
                                    	<!-- 显示单价 -->
                                    	<c:if test="${item.drinkSpec eq '超级杯'}">
                                    		<h6 class="product-price">￥${item.drink.drinkPrice_Super}</h6>
                                    	</c:if>
                                    	<c:if test="${item.drinkSpec eq '大杯'}">
                                    		<h6 class="product-price">￥${item.drink.drinkPrice_Big}</h6>
                                    	</c:if>
                                    	<c:if test="${item.drinkSpec eq '中杯'}">
                                    		<h6 class="product-price">￥${item.drink.drinkPrice_Medium}</h6>
                                    	</c:if>
                                    	
                                    	<!-- 显示每件商品的总价 -->
                                    	<c:if test="${item.drinkSpec eq '超级杯'}">
                                    		<h6 class="product-total-price">￥${item.number * item.drink.drinkPrice_Super}</h6>
                                    	</c:if>
                                    	<c:if test="${item.drinkSpec eq '大杯'}">
                                    		<h6 class="product-total-price">￥${item.number * item.drink.drinkPrice_Big}</h6>
                                    	</c:if>
                                    	<c:if test="${item.drinkSpec eq '中杯'}">
                                    		<h6 class="product-total-price">￥${item.number * item.drink.drinkPrice_Medium}</h6>
                                    	</c:if>
                                	</div>
                                </c:forEach>
                                
                            </div>

                            <div class="row text-center text-lg-left">
                                <div class="col-lg-5">
                                    <div class="continue-shopping">
                                        <a href="${pageContext.request.contextPath}/showProductByPage?DrinkType=All" class="theme-btn no-shadow bg-color5 br-10 rmt-30" type="submit">继续购买</a>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <div class="update-shopping text-lg-right">
                                        <a href="#" class="theme-btn no-shadow style-two br-10 rmt-30">更新购物车</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4">
                        <div class="cart-total-price p-50">
                            <h4 class="cart-heading">订单</h4>
                            <div class="total-item-wrap">
                                <div class="total-item sub-total">
                                    <span class="title">商品总价</span>
                                    <span class="price" id="totalPrice">￥${totalPrice}</span>
                                </div> 
                            </div>
                            <div class="proceed-btn mt-30">
                                <a href="checkout.html" class="theme-btn w-100 text-center br-10">支付</a>
                            </div>
                        </div>
                    </div>
                </div>

                
                
            </div>
        </section>
        <!--==================================================================== 
           End Cart Page
       =====================================================================-->
<jsp:include page="foot.jsp"></jsp:include>        
</div>

<!-- Scroll Top Button -->
    <button class="scroll-top scroll-to-target" data-target="html"><span class="fa fa-angle-up"></span></button>


    <!-- jequery plugins -->
    <script src="${pageContext.request.contextPath}/client/js/jquery.min.js"></script>
    <script src="${pageContext.request.contextPath}/client/js/bootstrap-v4.1.3.min.js"></script>
    <script src="${pageContext.request.contextPath}/client/js/jquery.nice-select.min.js"></script>
    <script src="${pageContext.request.contextPath}/client/js/jquery.simpleLoadMore.min.js"></script>
    <script src="${pageContext.request.contextPath}/client/js/slick.min.js"></script>
    <script src="${pageContext.request.contextPath}/client/js/appear.js"></script>

    <!-- Custom script -->
    <script src="${pageContext.request.contextPath}/client/js/script.js"></script>
</body>
</html>